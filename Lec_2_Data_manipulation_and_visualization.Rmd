---
title: "Data manipulation and visualization"
subtitle: "tidyverse: dplyr, tidyr, ggplot2"
date: 02.02.2017
font-family: 'Brill'
transition: none
output:
  slidy_presentation:
    df_print: paged
    footer: "Presentation link: https://goo.gl/fGi6Iv"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### 1.1 Data Types
* Vector
```{r}
c(42, 99, 43)
```
* Matrix, Array...
```{r}
matrix(1:12, nrow=3,ncol=4)
```
* List
```{r}
list(
  n_lectures = 12,
  l_topics = c("begining", "data manipulation", "descriptive stats"),
  h_topics = c("data manipulations", "descriptive stats")
  )
```

* Data Frame
```{r}
data.frame(
  names = c("Olya", "Ilya", "Sasha", "George"),
  lecturer = c(TRUE, TRUE, FALSE, TRUE),
  lecturer_experience = c(19, 6, 0, 3)
  )
```


[See Data Type Conversion page](http://www.statmethods.net/management/typeconversion.html)

### 1.2 Data Frame exploration
There are some embedded data frames (e. g. _mtcars_, _cars_, _iris_). How many rows and columns?
```{r}
nrow(iris) # returns the number of rows
ncol(mtcars) #  returns the number of columns
```
```{r}
head(cars) # returns the first 6 rows
head(cars, 4) # returns the first 4 rows
tail(cars) # returns the last 6 rows
summary(cars)  # produce some stats
str(cars)  # shows the structure: variables, their type
```

### 1.3 Data Frame Indexing
```{r}
mtcars$mpg # shows the mpg vector
mtcars[3,7] # shows the 3. row, 7. column
mtcars[3,] # shows the 3. row
mtcars[,7] # shows the 7. column
mtcars[mtcars$mpg < 20, ] # show all rows with the mpg value lower then 20
```

### 2. Tidyverse
The [_tidyverse_](https://blog.rstudio.org/2016/09/15/tidyverse-1-0-0/) is a set of packages:

* _dplyr_, for data manipulation
* _ggplot2_, for data visualisation
* _tidyr_, for data tidying
* _readr_, for data import
* _purrr_, for functional programming
* _tibble_, for tibbles, a modern re-imagining of data frames

Install _tidyverse_ package using _install.packages("tidyverse")_

Load tidyverse package
```{r, message= FALSE}
library(tidyverse)
```
In this presentation the folowing version of _tideverse_, _dplyr_ and _ggplot2_ are used:
```{r}
packageVersion("tidyverse")
packageVersion("dplyr")
packageVersion("ggplot2")
```

### 3.1 Join dataframe by row or column

```{r}
my_data_1 <- mtcars[5:20,] # select a subset of mtcars
my_data_2 <- mtcars[17:29,] # select a subset of mtcars
combine_rows <- rbind.data.frame(my_data_1, my_data_2)
nrow(my_data_1); nrow(my_data_2); nrow(combine_rows)
```

```{r}
my_data_3 <- mtcars[,3:7] # select a subset of mtcars
my_data_4 <- mtcars[,6:11] # select a subset of mtcars
combine_cols <- cbind.data.frame(my_data_3, my_data_4)
ncol(my_data_3); ncol(my_data_4); ncol(combine_cols)
```

### 3.2 Joins (dplyr)
```{r}
languages <- data.frame(
  languages = c("Selkup", "French", "Chukchi", "Kashubian"),
  countries = c("Russia", "France", "Russia", "Poland"),
  iso = c("sel", "fra", "ckt", "pol")
  )
languages
country_population <- data.frame(
  countries = c("Russia", "Poland", "Finland"),
  population_mln = c(143, 38, 5))
country_population
inner_join(languages, country_population)
left_join(languages, country_population)
right_join(languages, country_population)
anti_join(languages, country_population)
anti_join(country_population, languages)
full_join(country_population, languages)
```

### 3.3 Data
The majority of examples in that presentation are based on [Chi-kuk 2007](http://goo.gl/MKfSc6). Experiment consisted of a perception and judgment test aimed at measuring the correlation between acoustic cues and perceived sexual orientation. Naïve Cantonese speakers were asked to listen to the Cantonese speech samples collected in Experiment and judge whether the speakers were gay or heterosexual. There are 14 speakers and following parameters:

* [s] duration (_s.duration.ms_)
* vowel duration (_vowel.duration.ms_)
* fundamental frequencies mean (F0) (_average.f0.Hz_)
* fundamental frequencies range (_f0.range.Hz_)
* percentage of homosexual impression (_perceived.as.homo_)
* percentage of heterosexal impression (_perceived.as.hetero_)
* speakers orientation (_orientation_)
* speakers age (_age_)

Download data
```{r}
homo <- read.csv("http://goo.gl/Zjr9aF")
homo
```

### 3.4 Data Frame → Tibble (dplyr)
Tibble is a useful modification of Data Frame.
```{r}
homo <- tbl_df(homo)
homo
```

### 3.5 Filter (dplyr)
How many speakers are older than 28?

* base R
```{r}
homo[homo$age > 28,]
```
* _dplyr_
```{r}
homo %>%
  filter(age > 28)
```

%>%  is called *pipe*. Pipe is a technique for passing result of the work of one function to another.

```{r}
sort(sqrt(abs(sin(1:22))), decreasing = TRUE)
1:22 %>% 
  sin() %>% 
  abs() %>% 
  sqrt() %>% 
  sort(., decreasing = TRUE) # dot here shows where should argument be
```
Pipes in _tidyverse_ package came from _magritr_ package. Sometimes it works incorrectly with not _tidyverse_ functions.

### 3.6 Slice (dplyr)

* base R
```{r}
homo[3:7, ]
```

* _dplyr_
```{r}
homo %>%
  slice(3:7)
```


### 3.7 Select (dplyr)

* base R
```{r}
homo[, 8:10]
```

* _dplyr_
```{r}
homo %>%
  select(8:10)
```

* _dplyr_ only
```{r}
homo %>%
  select(speaker:average.f0.Hz)
```

### 3.8 arrange (dplyr)

* base R
```{r}
homo[order(homo$orientation, homo$age), ]
```

* _dplyr_
```{r}
homo %>%
  arrange(orientation, age)
```

### 3.9 distinct

* base R
```{r}
unique(homo$orientation)
```

* _dplyr_
```{r}
homo %>%
  distinct(orientation)
```

* base R
```{r}
unique(homo[c("orientation", "perceived.as.homo")])
```

* _dplyr_
```{r}
homo %>%
  distinct(orientation, perceived.as.homo)
```


### 3.10 mutate (dplyr)

* base R
```{r}
homo$f0.min <- homo$average.f0.Hz - homo$f0.range.Hz/2
homo$f0.min
homo$f0.max <- homo$average.f0.Hz + homo$f0.range.Hz/2
homo$f0.max
```

* _dplyr_
```{r}
homo %>%
  mutate(
   f0.min = average.f0.Hz - f0.range.Hz/2,
   f0.max = average.f0.Hz + f0.range.Hz/2)
```
### 3.11 group_by and summarise (dplyr)

```{r}
homo %>%
  summarise(min(age), mean(s.duration.ms))
```

```{r}
homo %>%
  group_by(orientation) %>% 
  summarise(count = n())
```

```{r}
homo %>%
  group_by(orientation) %>% 
  summarise(mean(s.duration.ms))
```

```{r}
homo %>%
  group_by(orientation) %>% 
  summarise(mean_by_orientation = mean(s.duration.ms))
```


### 4.1. tidyr package

* Short format
```{r, echo = FALSE}
df.short <- data.frame(
                   consonant = c("stops", "fricatives", "affricates", "nasals"),
                   initial = c(123, 87, 73, 7),
                   intervocal = c(57, 77, 82, 78),
                   final = c(30, 69, 12, 104))
df.short
```
* Long format
```{r, , echo = FALSE}
df.short %>% 
  gather(position, number, initial:final)
```

### 4.2 Short format → Long format: gather (tidyr)
```{r}
df.short <- data.frame(
                   consonant = c("stops", "fricatives", "affricates", "nasals"),
                   initial = c(123, 87, 73, 7),
                   intervocal = c(57, 77, 82, 78),
                   final = c(30, 69, 12, 104))
df.short

df.short %>% 
  gather(position, number, initial:final) ->
  df.long
```

### 4.2 Long format → Short format: spread (tidyr)
```{r}
df.long %>% 
  spread(position, number) ->
  df.short
```

